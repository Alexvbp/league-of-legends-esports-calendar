# Esports Calendar

Personalized esports match calendar feeds. Pick your teams, get a subscription URL that auto-updates.

Powered by [Liquipedia](https://liquipedia.net) data, [Cloudflare Pages](https://pages.cloudflare.com/) for hosting, and GitHub Actions for scraping.

## How It Works

1. **GitHub Actions** scrapes Liquipedia every 3 hours, commits JSON match data to the repo
2. That commit pushes to `main`, which **Cloudflare Pages** detects via its Git integration
3. Cloudflare auto-deploys — serves the static web UI and the dynamic `/api/calendar` endpoint
4. **You** pick teams on the web page and get a personalized calendar subscription URL
5. **Your calendar app** subscribes to the URL and auto-syncs every few hours

```
GET /api/calendar?teams=Los_Ratones,Fnatic
→ Returns merged ICS feed for selected teams
```

Also supports `&format=json` (JSON Feed v1.1) and `&format=rss` (Atom).

## Features

- **Auto-discovers teams** from all major LoL leagues (LEC, LCK, LPL, LCS, PCS, VCS, CBLOL, LLA, LJL)
- Personalized calendar URLs — pick any combination of teams
- ICS, RSS (Atom), and JSON Feed formats
- Upcoming and past matches (spoiler-free — no scores)
- Interactive web UI with drag-and-drop team selection
- webcal:// and Google Calendar one-click subscribe buttons
- Client-side local timezone display
- Pushover error notifications (optional)
- Automatic caching — serves last known good data on scrape failures
- 30-minute pre-match alarm reminders

## Quick Setup

### 1. Fork and Clone

```bash
git clone https://github.com/YOUR_USERNAME/esports-calendar.git
cd esports-calendar
```

### 2. Connect to Cloudflare Pages

1. Sign up or log in at [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. Go to **Workers & Pages** in the sidebar
3. Click **Create** > **Pages** > **Connect to Git**
4. Select your GitHub account and pick this repository
5. Configure build settings:
   - **Production branch:** `main`
   - **Framework preset:** None
   - **Build command:** `npm install` (installs TypeScript types for the Pages Function)
   - **Deploy command / Build output directory:** `public`
   - **Root path:** (leave empty)
6. Click **Save and Deploy**

> **How this works:** Cloudflare Pages serves everything in `public/` as static assets and automatically detects and compiles `functions/` for the Pages Function (`/api/calendar`). No wrangler deploy command is needed — Cloudflare's Git integration handles deployment. Match data is pre-generated by GitHub Actions and committed to the repo.

Cloudflare auto-deploys on every push to `main`. Your site will be available at `https://<project-name>.pages.dev`.

**Custom domain (optional):**
1. In Cloudflare Pages > your project > **Custom domains**
2. Click **Set up a custom domain** and follow the DNS instructions

**How it works:** GitHub Actions scrapes Liquipedia and commits JSON data to `public/data/`. Each push triggers a Cloudflare Pages deploy. The Pages Function at `functions/api/calendar.ts` dynamically generates ICS/RSS/JSON feeds from that data.

### 3. Configure GitHub Actions

The workflow runs automatically every 3 hours. It also runs on push to `main` when relevant files change (teams.json, leagues.json, src/, generate_data.py, scrape_teams.py).

**GitHub Actions needs write access** to push data commits back to the repo. This is already configured in the workflow file (`permissions: contents: write`), but you need to make sure your repo allows it:

1. Go to your repo on GitHub
2. Navigate to **Settings** > **Actions** > **General**
3. Scroll to **Workflow permissions**
4. Select **Read and write permissions**
5. Click **Save**

### 4. Configure Pushover Notifications (Optional)

Get notified on your phone when scraping fails or encounters errors.

**Step 1 — Create a Pushover account:**
1. Go to [pushover.net](https://pushover.net/) and sign up ($5 one-time purchase after 30-day free trial)
2. Install the Pushover app on your phone (iOS/Android)
3. After login, note your **User Key** shown on the main dashboard page

**Step 2 — Create an application:**
1. Go to [pushover.net/apps/build](https://pushover.net/apps/build)
2. Name it `Esports Calendar` (or anything you like)
3. Click **Create Application**
4. Note the **API Token/Key** shown on the next page

**Step 3 — Add secrets to GitHub:**
1. Go to your repo on GitHub
2. Navigate to **Settings** > **Secrets and variables** > **Actions**
3. Click **New repository secret**
4. Add secret name: `PUSHOVER_USER_KEY` — paste your User Key as the value
5. Click **Add secret**
6. Click **New repository secret** again
7. Add secret name: `PUSHOVER_API_TOKEN` — paste your API Token as the value
8. Click **Add secret**

You should now see both secrets listed (values are hidden). The workflow reads these via `${{ secrets.PUSHOVER_USER_KEY }}` and `${{ secrets.PUSHOVER_API_TOKEN }}`.

If these secrets aren't set, notifications are silently skipped — nothing breaks.

### 5. Run First Data Scrape

1. Go to your repo on GitHub
2. Click the **Actions** tab
3. Select **Update Match Data** from the left sidebar
4. Click **Run workflow** > **Run workflow** (on the `main` branch)
5. Wait for the workflow to complete (takes a few minutes)

This scrapes all teams and match data, then commits it to `public/data/`. The commit triggers a Cloudflare Pages deploy, and your site goes live.

## Teams

Teams are **auto-discovered** from all major LoL leagues. The GitHub Actions workflow runs `scrape_teams.py` weekly (Mondays) to refresh the team roster — not every 3 hours, to avoid excessive Liquipedia requests. It:

1. Reads `leagues.json` for the list of leagues to scan (LEC, LCK, LPL, LCS, PCS, VCS, CBLOL, LLA, LJL)
2. Scrapes each league's Liquipedia page for participating teams
3. Merges into `teams.json`, preserving any manual overrides (short names, emojis)

### Add a league

Edit `leagues.json` to add more leagues or games.

### Manual overrides

Edit `teams.json` directly to override auto-generated short names or emojis. The scraper preserves manual changes for existing teams.

### Force team refresh

To manually re-discover teams (e.g., mid-season roster changes):
1. Go to **Actions** > **Update Match Data** > **Run workflow**
2. Set **Re-discover teams from leagues** to `true`
3. Click **Run workflow**

### Run locally

```bash
python scrape_teams.py              # Scrape and write teams.json
python scrape_teams.py --dry-run    # Preview without writing
```

## Local Development

```bash
# Python: install and generate data
pip install -e ".[dev]"
python generate_data.py
# → public/data/*.json

# Node: run local Cloudflare dev server
npm install
npm run dev
# → http://localhost:8788

# Tests
pytest
```

## Project Structure

```
functions/api/calendar.ts          Cloudflare Pages Function (dynamic ICS/RSS/JSON)
public/
  index.html                       Interactive web UI
  data/teams.json                  Team manifest (generated)
  data/{slug}.json                 Per-team match data (generated)
src/
  __init__.py                      Data models (TeamConfig, Match)
  scraper.py                       Liquipedia scraping (upcoming + past)
  calendar_gen.py                  ICS generation (local dev / tests)
  feeds.py                         RSS + JSON feeds (local dev / tests)
  notify.py                        Pushover error notifications
  cache.py                         Data caching / fallback
tests/
  fixtures/                        Saved HTML for offline testing
  test_scraper.py                  Python tests
.github/workflows/update-data.yml  Scrape + commit data (3h cron)
leagues.json                       League configuration (which leagues to scan)
teams.json                         Auto-generated team roster (from leagues)
scrape_teams.py                    Team discovery from league pages
generate_data.py                   Match data generation (JSON output)
wrangler.toml                      Cloudflare Pages config
package.json                       Node dev dependencies
pyproject.toml                     Python project config
```

## API

| Endpoint | Description |
|----------|-------------|
| `GET /api/calendar?teams=LR,FNC` | Merged ICS calendar (default) |
| `GET /api/calendar?teams=LR&format=json` | JSON Feed v1.1 |
| `GET /api/calendar?teams=LR&format=rss` | Atom RSS feed |
| `GET /api/calendar?teams=LR&tournament=LEC` | Filter by tournament (substring match) |
| `GET /data/teams.json` | Team manifest |
| `GET /data/{slug}.json` | Per-team match data |

The `tournament` parameter filters matches by tournament name (case-insensitive substring). For example, `&tournament=LEC` includes only LEC matches, `&tournament=Versus` only LEC Versus matches.

## License

MIT
