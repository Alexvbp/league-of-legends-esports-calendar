<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Esports Calendar</title>
    <style>
        /* === CSS Custom Properties === */
        :root {
            --bg-base: #0b0b14;
            --bg-surface: #12121f;
            --bg-elevated: #1a1a2e;
            --bg-hover: #1e2540;
            --bg-accent: #16213e;
            --border: #1e1e36;
            --border-hover: #2e2e52;
            --text-primary: #e8e8f0;
            --text-secondary: #9898b0;
            --text-muted: #5c5c78;
            --text-faint: #3c3c56;
            --accent: #7dd3fc;
            --accent-dim: #1e3a5f;
            --accent-glow: rgba(125,211,252,0.12);
            --green: #34d399;
            --green-dim: #064e36;
            --orange: #fb923c;
            --orange-dim: #5c2d0e;
            --red: #f87171;
            --panel-width: 380px;
            --header-height: 60px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-pill: 9999px;
            --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace;
            --transition-fast: 0.15s ease;
            --transition-med: 0.25s ease;
        }

        /* === Reset & Base === */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, Roboto, sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            line-height: 1.55;
            overflow-x: hidden;
            min-height: 100vh;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
        button { font-family: inherit; cursor: pointer; border: none; background: none; color: inherit; }

        /* === Header === */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            height: var(--header-height);
            background: rgba(11,11,20,0.82);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 1.25rem;
            gap: 1rem;
        }
        .header-logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .header-logo svg { flex-shrink: 0; }
        .header-team-strip {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 0.25rem 0;
        }
        .header-team-strip::-webkit-scrollbar { display: none; }
        .header-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.5rem 0.25rem 0.6rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-pill);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
            flex-shrink: 0;
            transition: border-color var(--transition-fast), background var(--transition-fast);
        }
        .header-pill:hover { border-color: var(--border-hover); background: var(--bg-hover); }
        .header-pill .remove-x {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 0.65rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast);
        }
        .header-pill .remove-x:hover { background: var(--red); color: #fff; }
        .header-pill .team-logo {
            width: 16px;
            height: 16px;
            object-fit: contain;
            background: white;
            border-radius: 2px;
            padding: 1px;
        }
        .header-team-count {
            font-size: 0.72rem;
            color: var(--text-muted);
            white-space: nowrap;
            flex-shrink: 0;
        }
        /* Mobile menu toggle */
        .mobile-menu-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            transition: background var(--transition-fast);
        }
        .mobile-menu-btn:hover { background: var(--bg-elevated); }

        /* === Layout === */
        .layout {
            display: flex;
            min-height: calc(100vh - var(--header-height));
        }
        .panel {
            width: var(--panel-width);
            flex-shrink: 0;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
            display: flex;
            flex-direction: column;
        }
        .panel::-webkit-scrollbar { width: 5px; }
        .panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .main {
            flex: 1;
            min-width: 0;
            padding: 1.5rem;
            padding-bottom: 5rem; /* space for subscribe bar */
        }

        /* === Panel Sections === */
        .panel-section {
            padding: 1rem 1.15rem;
            border-bottom: 1px solid var(--border);
        }
        .panel-section:last-child { border-bottom: none; }
        .panel-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
            font-weight: 600;
        }

        /* League quick-add chips */
        .league-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .league-chip {
            padding: 0.3rem 0.65rem;
            border-radius: var(--radius-pill);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-base);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            user-select: none;
        }
        .league-chip:hover { border-color: var(--accent); color: var(--text-primary); }
        .league-chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .league-chip .chip-count {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-left: 0.15rem;
        }
        .league-chip.active .chip-count { color: var(--accent); opacity: 0.7; }

        /* Search */
        .team-search {
            width: 100%;
            padding: 0.5rem 0.7rem 0.5rem 2rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-base);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            outline: none;
            transition: border-color var(--transition-fast);
        }
        .team-search:focus { border-color: var(--accent); }
        .team-search::placeholder { color: var(--text-faint); }
        .search-wrap {
            position: relative;
            margin-bottom: 0.6rem;
        }
        .search-wrap svg {
            position: absolute;
            left: 0.6rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-faint);
            pointer-events: none;
        }

        /* Region filter pills */
        .region-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.6rem;
        }
        .region-tag {
            padding: 0.18rem 0.5rem;
            border-radius: var(--radius-pill);
            font-size: 0.7rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-base);
            color: var(--text-muted);
            transition: all var(--transition-fast);
            user-select: none;
        }
        .region-tag:hover { border-color: var(--accent); color: var(--text-secondary); }
        .region-tag.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

        /* League accordion */
        .league-group { margin-bottom: 0.25rem; }
        .league-group-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.45rem 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            user-select: none;
            transition: background var(--transition-fast);
            font-size: 0.85rem;
        }
        .league-group-header:hover { background: var(--bg-hover); }
        .league-group-header .chevron {
            color: var(--text-faint);
            transition: transform var(--transition-fast);
            flex-shrink: 0;
        }
        .league-group-header.collapsed .chevron { transform: rotate(-90deg); }
        .league-group-header .league-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        .league-group-header .league-count {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: auto;
        }
        .league-group-header .add-all-btn {
            font-size: 0.68rem;
            color: var(--accent);
            cursor: pointer;
            padding: 0.15rem 0.45rem;
            border-radius: var(--radius-sm);
            transition: background var(--transition-fast);
            white-space: nowrap;
        }
        .league-group-header .add-all-btn:hover { background: var(--accent-dim); }
        .league-group-body {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            padding: 0.35rem 0 0.35rem 1.4rem;
            overflow: hidden;
            transition: max-height var(--transition-med), opacity var(--transition-med);
        }
        .league-group-body.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* Team cards (browse) */
        .team-card {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: var(--bg-base);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0.35rem 0.6rem;
            cursor: pointer;
            transition: border-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
            user-select: none;
            font-size: 0.82rem;
        }
        .team-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--accent-glow);
        }
        .team-card.selected {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        .team-card .emoji { font-size: 1rem; }
        .team-card .team-logo {
            width: 20px;
            height: 20px;
            object-fit: contain;
            flex-shrink: 0;
            background: white;
            border-radius: 3px;
            padding: 2px;
        }
        .team-card .name { font-weight: 600; color: var(--text-primary); font-size: 0.8rem; }

        /* Selected teams section */
        .selected-teams-section {
            flex: 1;
            min-height: 0;
        }
        .selected-team-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }
        .selected-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.4rem 0.3rem 0.55rem;
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            border-radius: var(--radius-pill);
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--accent);
        }
        .selected-pill .remove-x {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 0.6rem;
            color: var(--accent);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast);
        }
        .selected-pill .remove-x:hover { background: var(--red); color: #fff; }
        .selected-pill .team-logo {
            width: 16px;
            height: 16px;
            object-fit: contain;
            background: white;
            border-radius: 2px;
            padding: 1px;
        }
        .clear-all-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.72rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            transition: color var(--transition-fast), background var(--transition-fast);
            margin-top: 0.4rem;
        }
        .clear-all-btn:hover { color: var(--red); background: rgba(248,113,113,0.08); }
        .selected-empty {
            color: var(--text-faint);
            font-size: 0.82rem;
            padding: 0.5rem 0;
        }

        /* === Hero Card === */
        .hero-card {
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--accent-dim) 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            pointer-events: none;
        }
        .hero-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .hero-matchup {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.35rem;
            position: relative;
        }
        .hero-tournament {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        .hero-countdown {
            display: flex;
            gap: 0.75rem;
            position: relative;
        }
        .countdown-unit {
            text-align: center;
        }
        .countdown-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
            line-height: 1;
        }
        .countdown-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        .hero-live {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--red);
            position: relative;
        }
        .hero-live::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--red);
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .hero-empty {
            color: var(--text-muted);
            font-size: 0.9rem;
            padding: 0.5rem 0;
        }

        /* === Tournament Filter === */
        .tournament-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 1rem;
        }
        .tournament-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.28rem 0.65rem;
            border-radius: var(--radius-pill);
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            user-select: none;
        }
        .tournament-tag:hover { border-color: var(--accent); color: var(--text-primary); }
        .tournament-tag.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .tournament-tag .count {
            font-size: 0.62rem;
            background: var(--bg-base);
            padding: 0.05rem 0.3rem;
            border-radius: var(--radius-pill);
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }
        .tournament-tag.active .count { background: rgba(125,211,252,0.1); color: var(--accent); }

        /* === Day Groups === */
        .day-group {
            margin-bottom: 1.25rem;
        }
        .day-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        .day-header .day-label {
            font-weight: 600;
            font-size: 0.88rem;
            color: var(--text-primary);
        }
        .day-header .day-count {
            font-size: 0.72rem;
            color: var(--text-muted);
        }
        .day-group.is-today .day-header {
            border-bottom-color: var(--accent);
        }
        .day-group.is-today::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
        }
        .day-group.is-today {
            position: relative;
            padding-left: 0.75rem;
        }
        .today-badge {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--accent);
            background: var(--accent-dim);
            padding: 0.12rem 0.45rem;
            border-radius: var(--radius-pill);
        }

        /* === Match Cards === */
        .match-cards {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .match-card {
            display: grid;
            grid-template-columns: 64px 1fr auto;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 0.85rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: transform var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
            text-decoration: none;
            color: inherit;
        }
        .match-card:hover {
            transform: translateX(2px);
            border-color: var(--border-hover);
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            text-decoration: none;
        }
        .match-card-time {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            font-size: 0.88rem;
            color: var(--text-primary);
        }
        .match-card-relative {
            font-size: 0.68rem;
            color: var(--text-muted);
        }
        .match-card-teams {
            font-weight: 600;
            font-size: 0.88rem;
            color: var(--text-primary);
        }
        .match-card-teams .vs {
            color: var(--text-muted);
            font-weight: 400;
            margin: 0 0.25rem;
        }
        .match-card-tournament {
            font-size: 0.72rem;
            color: var(--text-muted);
        }
        .match-card-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .match-badge {
            padding: 0.12rem 0.45rem;
            border-radius: var(--radius-pill);
            font-size: 0.65rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .match-badge-upcoming { background: var(--accent-dim); color: var(--accent); }
        .match-badge-live { background: rgba(248,113,113,0.15); color: var(--red); }
        .match-badge-past { background: var(--bg-elevated); color: var(--text-muted); }
        .match-card-link {
            color: var(--text-faint);
            transition: color var(--transition-fast);
            flex-shrink: 0;
        }
        .match-card:hover .match-card-link { color: var(--accent); }
        .match-card .team-logo, .hero-matchup .team-logo {
            width: 24px;
            height: 24px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 0.25rem;
            background: white;
            border-radius: 3px;
            padding: 2px;
        }
        .hero-matchup .team-logo {
            width: 32px;
            height: 32px;
            padding: 3px;
        }

        /* === Subscribe Bar === */
        .subscribe-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            background: rgba(18,18,31,0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid var(--border);
            transform: translateY(100%);
            transition: transform var(--transition-med);
        }
        .subscribe-bar.visible {
            transform: translateY(0);
            animation: glow-pulse 2s ease-in-out infinite, subtle-bounce 0.6s ease-out;
            box-shadow: 0 -4px 24px rgba(125,211,252,0.15);
        }
        @keyframes glow-pulse {
            0%, 100% {
                border-top-color: var(--border);
                box-shadow: 0 -4px 24px rgba(125,211,252,0.15);
            }
            50% {
                border-top-color: var(--accent);
                box-shadow: 0 -4px 32px rgba(125,211,252,0.25);
            }
        }
        @keyframes subtle-bounce {
            0% { transform: translateY(100%); }
            60% { transform: translateY(-8px); }
            80% { transform: translateY(4px); }
            100% { transform: translateY(0); }
        }
        .subscribe-bar-summary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.85rem 1.25rem;
            cursor: pointer;
            user-select: none;
            transition: background var(--transition-fast);
        }
        .subscribe-bar-summary:hover { background: var(--bg-hover); }
        .subscribe-bar-summary .sub-icon {
            color: var(--accent);
            animation: icon-pulse 2s ease-in-out infinite;
        }
        @keyframes icon-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .subscribe-bar-summary .sub-text {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .subscribe-bar-summary .sub-count {
            font-size: 0.72rem;
            color: var(--text-muted);
        }
        .subscribe-bar-summary .sub-chevron {
            color: var(--text-muted);
            transition: transform var(--transition-fast);
        }
        .subscribe-bar.expanded .sub-chevron { transform: rotate(180deg); }
        .subscribe-bar.expanded {
            animation: none;
            box-shadow: 0 -4px 24px rgba(125,211,252,0.15);
            border-top-color: var(--accent);
        }
        .subscribe-bar.expanded .sub-icon { animation: none; }
        .subscribe-drawer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 1.25rem;
        }
        .subscribe-bar.expanded .subscribe-drawer {
            max-height: 400px;
            padding: 0 1.25rem 1.25rem;
        }
        .subscribe-drawer-inner {
            max-width: 640px;
            margin: 0 auto;
        }
        .url-box {
            background: var(--bg-base);
            padding: 0.55rem 0.75rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.78rem;
            word-break: break-all;
            margin: 0.5rem 0;
            color: var(--accent);
            border: 1px solid var(--border);
        }
        .subscribe-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.5rem 0.9rem;
            border-radius: var(--radius-sm);
            font-size: 0.82rem;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: opacity var(--transition-fast), transform var(--transition-fast);
            font-family: inherit;
        }
        .btn:hover { opacity: 0.88; transform: translateY(-1px); text-decoration: none; }
        .btn-webcal { background: #2563eb; color: #fff; }
        .btn-google { background: #16a34a; color: #fff; }
        .btn-copy { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); }
        .feed-links {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.6rem;
            font-size: 0.78rem;
        }
        .feed-links a {
            padding: 0.2rem 0.5rem;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .feed-links a:hover { border-color: var(--accent); color: var(--accent); text-decoration: none; }
        .filtered-subscribe {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .filtered-label {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
        }
        .filtered-label strong { color: var(--accent); }

        /* === Section Headers === */
        .section-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-header .spoiler-note {
            font-weight: 400;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* === Empty & Loading States === */
        .empty-state {
            color: var(--text-muted);
            text-align: center;
            padding: 2rem 1rem;
            font-size: 0.88rem;
        }
        .empty-state svg { margin-bottom: 0.75rem; color: var(--text-faint); }
        .loading {
            color: var(--text-muted);
            padding: 3rem;
            text-align: center;
            font-size: 0.9rem;
        }

        /* === Footer === */
        .footer {
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-align: center;
            border-top: 1px solid var(--border);
        }
        .footer p + p { margin-top: 0.25rem; }

        /* === Mobile Tab Bar === */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 110;
            background: rgba(11,11,20,0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid var(--border);
        }
        .mobile-tabs-inner {
            display: flex;
        }
        .mobile-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            padding: 0.55rem 0;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: color var(--transition-fast);
            min-height: 44px;
            justify-content: center;
            user-select: none;
        }
        .mobile-tab:hover { color: var(--text-secondary); }
        .mobile-tab.active { color: var(--accent); }
        .mobile-tab svg { width: 20px; height: 20px; }
        .mobile-tab .tab-badge {
            position: absolute;
            top: 4px;
            right: calc(50% - 16px);
            background: var(--accent);
            color: var(--bg-base);
            font-size: 0.55rem;
            font-weight: 700;
            padding: 0.05rem 0.3rem;
            border-radius: var(--radius-pill);
            min-width: 14px;
            text-align: center;
        }

        /* === Responsive: Tablet === */
        @media (max-width: 1199px) {
            .panel {
                position: fixed;
                left: 0;
                top: var(--header-height);
                bottom: 0;
                z-index: 80;
                transform: translateX(-100%);
                transition: transform var(--transition-med);
                box-shadow: none;
            }
            .panel.open {
                transform: translateX(0);
                box-shadow: 4px 0 24px rgba(0,0,0,0.5);
            }
            .mobile-menu-btn { display: flex; }
            .panel-overlay {
                display: none;
                position: fixed;
                inset: 0;
                top: var(--header-height);
                background: rgba(0,0,0,0.5);
                z-index: 79;
            }
            .panel-overlay.visible { display: block; }
            .main { padding: 1.25rem; }
        }

        /* === Responsive: Mobile === */
        @media (max-width: 767px) {
            .header-team-strip { display: none; }
            .header-team-count { display: none; }
            .mobile-tabs { display: block; }
            .panel {
                width: 100%;
                transform: translateX(-100%);
            }
            .panel.open { transform: translateX(0); }
            .main {
                padding: 1rem;
                padding-bottom: 4.5rem;
            }
            /* Mobile view switching */
            body.mobile-view-teams .panel { transform: translateX(0); position: fixed; z-index: 80; }
            body.mobile-view-teams .main { display: none; }
            body.mobile-view-subscribe .subscribe-bar { transform: translateY(0); }
            body.mobile-view-subscribe .subscribe-bar.visible { position: fixed; bottom: 48px; }

            .hero-matchup { font-size: 1.2rem; }
            .countdown-value { font-size: 1.4rem; }
            .hero-card { padding: 1.15rem; }
            .match-card {
                grid-template-columns: 54px 1fr auto;
                gap: 0.5rem;
                padding: 0.55rem 0.65rem;
            }
            .match-badge { display: none; }
            .subscribe-bar { bottom: 48px; }
            .subscribe-bar-summary { padding: 0.7rem 1rem; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="header">
        <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle team panel">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <div class="header-logo">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            Esports Calendar
        </div>
        <div class="header-team-strip" id="header-strip"></div>
        <span class="header-team-count" id="header-count"></span>
    </header>

    <!-- Panel overlay (tablet/mobile) -->
    <div class="panel-overlay" id="panel-overlay"></div>

    <div id="loading" class="loading">Loading teams...</div>

    <div class="layout" id="layout" style="display:none">
        <!-- Left Panel -->
        <aside class="panel" id="panel">
            <!-- League Quick-Add -->
            <div class="panel-section" id="league-chips-section">
                <div class="panel-section-title">Quick Add by League</div>
                <div class="league-chips" id="league-chips"></div>
            </div>

            <!-- Search & Browse -->
            <div class="panel-section" style="flex:1;overflow-y:auto;min-height:0;display:flex;flex-direction:column">
                <div class="panel-section-title">Browse Teams</div>
                <div class="search-wrap">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" class="team-search" id="team-search" placeholder="Search teams...">
                </div>
                <div class="region-filters" id="region-filters"></div>
                <div id="team-browse" style="flex:1;overflow-y:auto"></div>
            </div>

            <!-- Selected Teams -->
            <div class="panel-section selected-teams-section" id="selected-section">
                <div class="panel-section-title">
                    Selected <span id="selected-count-badge" style="font-size:0.65rem;background:var(--accent-dim);color:var(--accent);padding:0.05rem 0.4rem;border-radius:var(--radius-pill);margin-left:0.3rem"></span>
                </div>
                <div class="selected-team-list" id="selected-list"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main" id="main-content">
            <!-- Hero (next match countdown) -->
            <div id="hero-container"></div>

            <!-- Upcoming Matches -->
            <div id="upcoming-section" style="display:none">
                <div class="section-header">Upcoming Matches</div>
                <div id="tournament-filter-upcoming" class="tournament-filter"></div>
                <div id="upcoming-container"></div>
            </div>

            <!-- Recent Matches -->
            <div id="past-section" style="display:none">
                <div class="section-header">
                    Recent Matches <span class="spoiler-note">(spoiler-free)</span>
                </div>
                <div id="tournament-filter-past" class="tournament-filter"></div>
                <div id="past-container"></div>
            </div>

            <!-- Empty state when no teams selected -->
            <div id="no-teams-state" class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="9" y1="14" x2="15" y2="14"/><line x1="12" y1="11" x2="12" y2="17"/></svg>
                <p>Select teams from the panel to see their upcoming matches</p>
            </div>

            <div class="footer" id="footer">
                <p id="footer-updated"></p>
                <p>Data sourced from <a href="https://liquipedia.net" target="_blank" rel="noopener">Liquipedia</a>. Feeds available as ICS, RSS, and JSON.</p>
            </div>
        </main>
    </div>

    <!-- Subscribe Bar -->
    <div class="subscribe-bar" id="subscribe-bar">
        <div class="subscribe-bar-summary" id="subscribe-toggle">
            <span class="sub-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </span>
            <span class="sub-text">Subscribe to your calendar</span>
            <span class="sub-count" id="sub-count"></span>
            <span class="sub-chevron">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
            </span>
        </div>
        <div class="subscribe-drawer">
            <div class="subscribe-drawer-inner">
                <div style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:0.3rem">Add this URL to your calendar app:</div>
                <div class="url-box" id="subscribe-url"></div>
                <div class="subscribe-buttons">
                    <a id="btn-webcal" class="btn btn-webcal" href="#">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        webcal:// Subscribe
                    </a>
                    <a id="btn-google" class="btn btn-google" href="#" target="_blank" rel="noopener">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Google Calendar
                    </a>
                    <button id="btn-copy" class="btn btn-copy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        Copy URL
                    </button>
                </div>
                <div class="feed-links">
                    <a id="link-rss" href="#">RSS Feed</a>
                    <a id="link-json" href="#">JSON Feed</a>
                </div>
                <div id="tournament-subscribe" class="filtered-subscribe" style="display:none">
                    <div class="filtered-label">Filtered to: <strong id="tournament-filter-label"></strong></div>
                    <div class="url-box" id="subscribe-url-filtered" style="font-size:0.75rem"></div>
                    <div class="subscribe-buttons">
                        <a id="btn-webcal-filtered" class="btn btn-webcal" href="#" style="font-size:0.78rem;padding:0.4rem 0.75rem">webcal:// (filtered)</a>
                        <button id="btn-copy-filtered" class="btn btn-copy" style="font-size:0.78rem;padding:0.4rem 0.75rem">Copy filtered URL</button>
                    </div>
                </div>
                <p style="margin-top:0.6rem;font-size:0.72rem;color:var(--text-muted)">
                    Auto-updates every few hours. Your calendar app will sync changes automatically.
                </p>
            </div>
        </div>
    </div>

    <!-- Mobile Tab Bar -->
    <nav class="mobile-tabs" id="mobile-tabs">
        <div class="mobile-tabs-inner">
            <div class="mobile-tab" data-tab="teams" style="position:relative">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                Teams
            </div>
            <div class="mobile-tab active" data-tab="schedule">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Schedule
            </div>
            <div class="mobile-tab" data-tab="subscribe">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg>
                Subscribe
            </div>
        </div>
    </nav>

<script>
// =====================================================================
// State
// =====================================================================
let allTeams = [];
let leagues = [];
let leagueTeamMap = {};      // league name → [team slugs]
let teamLeagueMap = {};      // team slug → league name
let selectedSlugs = JSON.parse(localStorage.getItem('selectedTeams') || '[]');
let teamDataCache = {};
let activeTournamentFilter = { upcoming: null, past: null };
let teamSearchQuery = '';
let activeRegionFilter = null;
let countdownInterval = null;
let mobileActiveTab = 'schedule';

// Emoji → region label mapping
const EMOJI_REGIONS = {
    '\u{1F1EA}\u{1F1FA}': 'Europe',
    '\u{1F1F0}\u{1F1F7}': 'Korea',
    '\u{1F1E8}\u{1F1F3}': 'China',
    '\u{1F1FA}\u{1F1F8}': 'NA',
    '\u{1F1E7}\u{1F1F7}': 'Brazil',
    '\u{1F1FB}\u{1F1F3}': 'Vietnam',
    '\u{1F1EF}\u{1F1F5}': 'Japan',
    '\u{1F30F}': 'Pacific',
    '\u{1F30E}': 'LATAM',
    '\u{1F400}': 'Europe',
};

// Region → league mapping (from leagues.json regions)
const REGION_TO_LEAGUE = {
    'Europe': 'LEC',
    'Korea': 'LCK',
    'China': 'LPL',
    'North America': 'LCS',
    'NA': 'LCS',
    'Pacific': 'PCS',
    'Vietnam': 'VCS',
    'Brazil': 'CBLOL',
    'Latin America': 'LLA',
    'LATAM': 'LLA',
    'Japan': 'LJL',
};

// =====================================================================
// Init
// =====================================================================
async function init() {
    try {
        const teamsResp = await fetch('/data/teams.json');
        if (!teamsResp.ok) throw new Error('Failed to load teams');
        const manifest = await teamsResp.json();
        allTeams = manifest.teams;

        // Leagues fetch is best-effort — if it fails (e.g. file not in public/),
        // we fall back to building leagues from emoji→region mapping alone.
        try {
            const leaguesResp = await fetch('/data/leagues.json');
            if (leaguesResp.ok) {
                const ct = leaguesResp.headers.get('content-type') || '';
                if (ct.includes('json')) {
                    const leaguesData = await leaguesResp.json();
                    leagues = leaguesData.leagues || [];
                }
            }
        } catch (_) {
            // leagues stays empty — buildLeagueMapping handles this
        }

        // Build league→teams mapping
        buildLeagueMapping();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('layout').style.display = '';

        const validSlugs = new Set(allTeams.map(t => t.slug));
        selectedSlugs = selectedSlugs.filter(s => validSlugs.has(s));

        render();

        if (manifest.generated_utc) {
            const d = new Date(manifest.generated_utc);
            document.getElementById('footer-updated').textContent =
                'Last updated: ' + d.toLocaleString();
        }
    } catch (e) {
        document.getElementById('loading').textContent =
            'Failed to load team data. Please try again later.';
    }
}

function buildLeagueMapping() {
    // Map each team to a league based on emoji → region → league
    leagueTeamMap = {};
    teamLeagueMap = {};

    // If leagues.json didn't load, use hardcoded league order
    if (leagues.length === 0) {
        leagues = [
            { name: 'LEC' }, { name: 'LCK' }, { name: 'LPL' }, { name: 'LCS' },
            { name: 'PCS' }, { name: 'VCS' }, { name: 'CBLOL' }, { name: 'LLA' }, { name: 'LJL' }
        ];
    }

    for (const league of leagues) {
        leagueTeamMap[league.name] = [];
    }

    for (const team of allTeams) {
        const emojiRegion = EMOJI_REGIONS[team.emoji];
        let leagueName = null;

        if (emojiRegion) {
            leagueName = REGION_TO_LEAGUE[emojiRegion];
        }

        if (!leagueName) {
            // Fallback: try matching team region from any league
            leagueName = 'Other';
        }

        if (!leagueTeamMap[leagueName]) {
            leagueTeamMap[leagueName] = [];
        }
        leagueTeamMap[leagueName].push(team.slug);
        teamLeagueMap[team.slug] = leagueName;
    }

    // Remove empty leagues
    for (const key of Object.keys(leagueTeamMap)) {
        if (leagueTeamMap[key].length === 0) delete leagueTeamMap[key];
    }
}

// =====================================================================
// Rendering
// =====================================================================
function render() {
    renderLeagueChips();
    renderTeamBrowse();
    renderSelectedTeams();
    renderHeaderStrip();
    renderSubscribeBar();
    loadAndRenderMatches();
    saveSelection();
    updateNoTeamsState();
}

function updateNoTeamsState() {
    const noTeams = document.getElementById('no-teams-state');
    const upcoming = document.getElementById('upcoming-section');
    const past = document.getElementById('past-section');
    if (selectedSlugs.length === 0) {
        noTeams.style.display = '';
        upcoming.style.display = 'none';
        past.style.display = 'none';
    } else {
        noTeams.style.display = 'none';
    }
}

// --- League Chips ---
function renderLeagueChips() {
    const container = document.getElementById('league-chips');
    const selectedSet = new Set(selectedSlugs);

    // Order: leagues from leagues.json first, then "Other" if it exists
    const orderedLeagues = leagues.map(l => l.name).filter(n => leagueTeamMap[n]);
    if (leagueTeamMap['Other']) orderedLeagues.push('Other');

    let html = '';
    for (const name of orderedLeagues) {
        const teams = leagueTeamMap[name] || [];
        const allSelected = teams.length > 0 && teams.every(s => selectedSet.has(s));
        const someSelected = teams.some(s => selectedSet.has(s));
        const cls = allSelected ? ' active' : (someSelected ? ' partial' : '');
        html += `<span class="league-chip${cls}" data-league="${esc(name)}">${esc(name)}<span class="chip-count">${teams.length}</span></span>`;
    }
    container.innerHTML = html;
}

// --- Team Browse (league-grouped accordion) ---
function renderTeamBrowse() {
    const container = document.getElementById('team-browse');
    const selectedSet = new Set(selectedSlugs);

    // Region filter pills
    const allAvailable = allTeams.filter(t => !selectedSet.has(t.slug));
    const regionCounts = {};
    for (const t of allAvailable) {
        const region = EMOJI_REGIONS[t.emoji] || 'Other';
        regionCounts[region] = (regionCounts[region] || 0) + 1;
    }
    const regions = Object.keys(regionCounts).sort();
    let regionHTML = `<span class="region-tag${!activeRegionFilter ? ' active' : ''}" data-region="">All</span>`;
    for (const r of regions) {
        regionHTML += `<span class="region-tag${activeRegionFilter === r ? ' active' : ''}" data-region="${esc(r)}">${esc(r)}</span>`;
    }
    document.getElementById('region-filters').innerHTML = regionHTML;

    // Filter teams
    let filteredTeams = allAvailable;
    if (teamSearchQuery) {
        const q = teamSearchQuery.toLowerCase();
        filteredTeams = filteredTeams.filter(t =>
            t.name.toLowerCase().includes(q) ||
            t.short_name.toLowerCase().includes(q) ||
            t.slug.toLowerCase().includes(q)
        );
    }
    if (activeRegionFilter) {
        filteredTeams = filteredTeams.filter(t =>
            (EMOJI_REGIONS[t.emoji] || 'Other') === activeRegionFilter
        );
    }

    // Group filtered teams by league
    const groups = {};
    for (const t of filteredTeams) {
        const league = teamLeagueMap[t.slug] || 'Other';
        if (!groups[league]) groups[league] = [];
        groups[league].push(t);
    }

    // Order leagues
    const orderedLeagues = leagues.map(l => l.name).filter(n => groups[n]);
    if (groups['Other']) orderedLeagues.push('Other');

    if (filteredTeams.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:1rem">No teams match your filter</div>';
        return;
    }

    let html = '';
    for (const leagueName of orderedLeagues) {
        const teams = groups[leagueName] || [];
        if (teams.length === 0) continue;

        const allInLeague = leagueTeamMap[leagueName] || [];
        const selectedInLeague = allInLeague.filter(s => selectedSet.has(s)).length;
        const addAllLabel = selectedInLeague === allInLeague.length ? 'Remove All' :
                           selectedInLeague > 0 ? `Add ${allInLeague.length - selectedInLeague} more` : 'Add All';

        html += `<div class="league-group">
            <div class="league-group-header" data-league-toggle="${esc(leagueName)}">
                <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                <span class="league-label">${esc(leagueName)}</span>
                <span class="league-count">${teams.length} team${teams.length !== 1 ? 's' : ''}</span>
                <span class="add-all-btn" data-add-all="${esc(leagueName)}">${addAllLabel}</span>
            </div>
            <div class="league-group-body" style="max-height:500px">
                ${teams.map(t => `<div class="team-card${selectedSet.has(t.slug) ? ' selected' : ''}" data-slug="${esc(t.slug)}">
                    ${teamIcon(t)}
                    <span class="name">${esc(t.short_name)}</span>
                </div>`).join('')}
            </div>
        </div>`;
    }
    container.innerHTML = html;
}

// --- Selected Teams ---
function renderSelectedTeams() {
    const list = document.getElementById('selected-list');
    const badge = document.getElementById('selected-count-badge');
    badge.textContent = selectedSlugs.length || '';

    if (selectedSlugs.length === 0) {
        list.innerHTML = '<div class="selected-empty">Click teams or leagues to add them</div>';
        return;
    }

    let html = '';
    for (const slug of selectedSlugs) {
        const team = allTeams.find(t => t.slug === slug);
        if (!team) continue;
        html += `<span class="selected-pill" data-slug="${esc(slug)}">
            ${teamIcon(team)} ${esc(team.short_name)}
            <span class="remove-x" data-remove="${esc(slug)}">&times;</span>
        </span>`;
    }
    html += `<button class="clear-all-btn" id="clear-all-btn">Clear all</button>`;
    list.innerHTML = html;
}

// --- Header Team Strip ---
function renderHeaderStrip() {
    const strip = document.getElementById('header-strip');
    const count = document.getElementById('header-count');

    if (selectedSlugs.length === 0) {
        strip.innerHTML = '';
        count.textContent = '';
        return;
    }

    let html = '';
    for (const slug of selectedSlugs) {
        const team = allTeams.find(t => t.slug === slug);
        if (!team) continue;
        html += `<span class="header-pill" data-slug="${esc(slug)}">
            ${teamIcon(team)} ${esc(team.short_name)}
            <span class="remove-x" data-remove="${esc(slug)}">&times;</span>
        </span>`;
    }
    strip.innerHTML = html;
    count.textContent = selectedSlugs.length + ' team' + (selectedSlugs.length !== 1 ? 's' : '');
}

// --- Subscribe Bar ---
function renderSubscribeBar() {
    const bar = document.getElementById('subscribe-bar');
    const countEl = document.getElementById('sub-count');

    if (selectedSlugs.length === 0) {
        bar.classList.remove('visible');
        return;
    }

    bar.classList.add('visible');
    countEl.textContent = '\u00b7 ' + selectedSlugs.length + ' team' + (selectedSlugs.length !== 1 ? 's' : '');

    const base = window.location.origin;
    const teamsParam = selectedSlugs.join(',');
    const icsUrl = base + '/api/calendar?teams=' + encodeURIComponent(teamsParam);
    const webcalUrl = icsUrl.replace(/^https?:/, 'webcal:');
    const googleUrl = 'https://calendar.google.com/calendar/r?cid=' + encodeURIComponent(webcalUrl);
    const rssUrl = icsUrl + '&format=rss';
    const jsonUrl = icsUrl + '&format=json';

    document.getElementById('subscribe-url').textContent = icsUrl;
    document.getElementById('btn-webcal').href = webcalUrl;
    document.getElementById('btn-google').href = googleUrl;
    document.getElementById('link-rss').href = rssUrl;
    document.getElementById('link-json').href = jsonUrl;

    updateFilteredSubscribe();
}

function updateFilteredSubscribe() {
    const filterDiv = document.getElementById('tournament-subscribe');
    const activeFilter = activeTournamentFilter.upcoming || activeTournamentFilter.past;

    if (!activeFilter) {
        filterDiv.style.display = 'none';
        return;
    }

    filterDiv.style.display = '';
    const base = window.location.origin;
    const teamsParam = selectedSlugs.join(',');
    const filteredUrl = base + '/api/calendar?teams=' + encodeURIComponent(teamsParam) +
        '&tournament=' + encodeURIComponent(activeFilter);
    const webcalFiltered = filteredUrl.replace(/^https?:/, 'webcal:');

    document.getElementById('tournament-filter-label').textContent = activeFilter;
    document.getElementById('subscribe-url-filtered').textContent = filteredUrl;
    document.getElementById('btn-webcal-filtered').href = webcalFiltered;
}

// =====================================================================
// Matches
// =====================================================================
async function loadAndRenderMatches() {
    if (selectedSlugs.length === 0) return;

    const allUpcoming = [];
    const allPast = [];

    for (const slug of selectedSlugs) {
        let data = teamDataCache[slug];
        if (!data) {
            try {
                const resp = await fetch('/data/' + slug.toLowerCase() + '.json');
                if (resp.ok) {
                    data = await resp.json();
                    teamDataCache[slug] = data;
                }
            } catch {}
        }
        if (!data) continue;

        for (const m of data.matches) {
            const entry = { ...m, team: data.team };
            if (m.is_upcoming) allUpcoming.push(entry);
            else allPast.push(entry);
        }
    }

    allUpcoming.sort((a, b) => a.timestamp - b.timestamp);
    allPast.sort((a, b) => b.timestamp - a.timestamp);

    document.getElementById('upcoming-section').style.display = '';
    document.getElementById('past-section').style.display = '';

    renderHero(allUpcoming);
    renderMatchSection('upcoming', allUpcoming, true);
    renderMatchSection('past', allPast.slice(0, 30), false);
}

// --- Hero Card ---
function renderHero(upcoming) {
    const container = document.getElementById('hero-container');

    if (upcoming.length === 0) {
        container.innerHTML = '';
        if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        return;
    }

    const next = upcoming[0];
    const d = new Date(next.timestamp * 1000);
    const now = Date.now();
    const diff = next.timestamp * 1000 - now;

    container.innerHTML = `<div class="hero-card">
        <div class="hero-label">Next Match</div>
        <div class="hero-matchup">${teamIcon(next.team)} ${esc(next.team.short_name)} <span style="color:var(--text-muted);font-weight:400">vs</span> ${opponentIcon(next.opponent)}${esc(next.opponent)}</div>
        <div class="hero-tournament">${esc(next.tournament)}</div>
        <div id="hero-countdown-wrap">
            ${diff > 0 ? renderCountdown(diff) : '<span class="hero-live">LIVE NOW</span>'}
        </div>
    </div>`;

    // Start countdown
    if (countdownInterval) clearInterval(countdownInterval);
    if (diff > 0) {
        countdownInterval = setInterval(function() {
            const remaining = next.timestamp * 1000 - Date.now();
            const wrap = document.getElementById('hero-countdown-wrap');
            if (!wrap) { clearInterval(countdownInterval); return; }
            if (remaining <= 0) {
                wrap.innerHTML = '<span class="hero-live">LIVE NOW</span>';
                clearInterval(countdownInterval);
            } else {
                wrap.innerHTML = renderCountdown(remaining);
            }
        }, 1000);
    }
}

function renderCountdown(ms) {
    const totalSec = Math.floor(ms / 1000);
    const days = Math.floor(totalSec / 86400);
    const hours = Math.floor((totalSec % 86400) / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    const secs = totalSec % 60;

    let html = '<div class="hero-countdown">';
    if (days > 0) html += `<div class="countdown-unit"><div class="countdown-value">${days}</div><div class="countdown-label">days</div></div>`;
    html += `<div class="countdown-unit"><div class="countdown-value">${String(hours).padStart(2,'0')}</div><div class="countdown-label">hours</div></div>`;
    html += `<div class="countdown-unit"><div class="countdown-value">${String(mins).padStart(2,'0')}</div><div class="countdown-label">mins</div></div>`;
    html += `<div class="countdown-unit"><div class="countdown-value">${String(secs).padStart(2,'0')}</div><div class="countdown-label">secs</div></div>`;
    html += '</div>';
    return html;
}

// --- Match Section ---
function renderMatchSection(type, matches, isUpcoming) {
    const filterContainer = document.getElementById('tournament-filter-' + type);
    const matchContainer = document.getElementById(type + '-container');

    if (matches.length === 0) {
        filterContainer.innerHTML = '';
        matchContainer.innerHTML = '<div class="empty-state">No ' +
            (isUpcoming ? 'upcoming' : 'recent') + ' matches</div>';
        return;
    }

    // Extract tournaments
    const tournamentCounts = {};
    for (const m of matches) {
        const baseTournament = normalizeTournament(m.tournament);
        tournamentCounts[baseTournament] = (tournamentCounts[baseTournament] || 0) + 1;
    }
    const tournaments = Object.keys(tournamentCounts).sort();

    // Filter tags
    const activeFilter = activeTournamentFilter[type];
    let filterHTML = '';
    if (tournaments.length > 1) {
        filterHTML += `<span class="tournament-tag${!activeFilter ? ' active' : ''}" data-filter-type="${type}" data-tournament="">All <span class="count">${matches.length}</span></span>`;
        for (const t of tournaments) {
            filterHTML += `<span class="tournament-tag${activeFilter === t ? ' active' : ''}" data-filter-type="${type}" data-tournament="${esc(t)}">${esc(t)} <span class="count">${tournamentCounts[t]}</span></span>`;
        }
    }
    filterContainer.innerHTML = filterHTML;

    // Filter
    const filtered = activeFilter
        ? matches.filter(m => normalizeTournament(m.tournament) === activeFilter)
        : matches;

    // Group by day
    const dayGroups = {};
    for (const m of filtered) {
        const d = new Date(m.timestamp * 1000);
        const dayKey = d.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
        if (!dayGroups[dayKey]) dayGroups[dayKey] = { date: d, matches: [] };
        dayGroups[dayKey].matches.push(m);
    }

    const today = new Date();
    const todayStr = today.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });

    let html = '';
    for (const [dayLabel, group] of Object.entries(dayGroups)) {
        const isToday = dayLabel === todayStr;
        html += `<div class="day-group${isToday ? ' is-today' : ''}">
            <div class="day-header">
                <span class="day-label">${esc(dayLabel)}</span>
                ${isToday ? '<span class="today-badge">TODAY</span>' : ''}
                <span class="day-count">${group.matches.length} match${group.matches.length !== 1 ? 'es' : ''}</span>
            </div>
            <div class="match-cards">
                ${group.matches.map(m => matchCardHTML(m, isUpcoming)).join('')}
            </div>
        </div>`;
    }

    matchContainer.innerHTML = html;
}

function matchCardHTML(m, isUpcoming) {
    const d = new Date(m.timestamp * 1000);
    const timeStr = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    const now = Date.now();
    const diff = m.timestamp * 1000 - now;
    const relTime = getRelativeTime(diff);

    let badgeHTML = '';
    if (isUpcoming) {
        if (diff <= 0 && diff > -3600000 * 3) {
            badgeHTML = '<span class="match-badge match-badge-live">LIVE</span>';
        } else {
            badgeHTML = '<span class="match-badge match-badge-upcoming">Upcoming</span>';
        }
    } else {
        badgeHTML = '<span class="match-badge match-badge-past">Played</span>';
    }

    const linkAttr = m.url ? `data-url="${esc(m.url)}"` : '';
    const linkIcon = m.url ? '<span class="match-card-link"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></span>' : '';

    return `<div class="match-card" ${linkAttr}>
        <div>
            <div class="match-card-time">${timeStr}</div>
            <div class="match-card-relative">${esc(relTime)}</div>
        </div>
        <div>
            <div class="match-card-teams">${teamIcon(m.team)} ${esc(m.team.short_name)} <span class="vs">vs</span> ${opponentIcon(m.opponent)}${esc(m.opponent)}</div>
            <div class="match-card-tournament">${esc(m.tournament)}</div>
        </div>
        <div class="match-card-meta">
            ${badgeHTML}
            ${linkIcon}
        </div>
    </div>`;
}

function getRelativeTime(diffMs) {
    const absDiff = Math.abs(diffMs);
    const isFuture = diffMs > 0;

    if (absDiff < 60000) return isFuture ? 'now' : 'just now';
    if (absDiff < 3600000) {
        const m = Math.floor(absDiff / 60000);
        return isFuture ? 'in ' + m + 'm' : m + 'm ago';
    }
    if (absDiff < 86400000) {
        const h = Math.floor(absDiff / 3600000);
        return isFuture ? 'in ' + h + 'h' : h + 'h ago';
    }
    const d = Math.floor(absDiff / 86400000);
    return isFuture ? 'in ' + d + 'd' : d + 'd ago';
}

function normalizeTournament(name) {
    return name.replace(/\s*-\s*(Week|Day|Round|Match\s*Day)\s*\d+.*$/i, '').trim();
}

// =====================================================================
// Actions
// =====================================================================
function toggleTeam(slug) {
    const idx = selectedSlugs.indexOf(slug);
    if (idx >= 0) {
        selectedSlugs.splice(idx, 1);
    } else {
        selectedSlugs.push(slug);
    }
    activeTournamentFilter = { upcoming: null, past: null };
    teamDataCache = {};
    render();
}

function toggleLeague(leagueName) {
    const teams = leagueTeamMap[leagueName] || [];
    if (teams.length === 0) return;

    const selectedSet = new Set(selectedSlugs);
    const allSelected = teams.every(s => selectedSet.has(s));

    if (allSelected) {
        // Remove all league teams
        selectedSlugs = selectedSlugs.filter(s => !teams.includes(s));
    } else {
        // Add missing league teams
        for (const s of teams) {
            if (!selectedSet.has(s)) selectedSlugs.push(s);
        }
    }
    activeTournamentFilter = { upcoming: null, past: null };
    teamDataCache = {};
    render();
}

function addAllLeague(leagueName) {
    const teams = leagueTeamMap[leagueName] || [];
    const selectedSet = new Set(selectedSlugs);
    const allInLeagueSelected = teams.every(s => selectedSet.has(s));

    if (allInLeagueSelected) {
        selectedSlugs = selectedSlugs.filter(s => !teams.includes(s));
    } else {
        for (const s of teams) {
            if (!selectedSet.has(s)) selectedSlugs.push(s);
        }
    }
    activeTournamentFilter = { upcoming: null, past: null };
    teamDataCache = {};
    render();
}

function clearAll() {
    selectedSlugs = [];
    activeTournamentFilter = { upcoming: null, past: null };
    teamDataCache = {};
    render();
}

function setTournamentFilter(type, tournament) {
    activeTournamentFilter[type] = tournament;
    loadAndRenderMatches();
    updateFilteredSubscribe();
}

function setRegionFilter(region) {
    activeRegionFilter = region;
    renderTeamBrowse();
}

function saveSelection() {
    localStorage.setItem('selectedTeams', JSON.stringify(selectedSlugs));
}

function copyUrl() {
    const url = document.getElementById('subscribe-url').textContent;
    navigator.clipboard.writeText(url).then(function() {
        const btn = document.getElementById('btn-copy');
        const orig = btn.innerHTML;
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.innerHTML = orig; }, 2000);
    });
}

function copyFilteredUrl() {
    const url = document.getElementById('subscribe-url-filtered').textContent;
    navigator.clipboard.writeText(url).then(function() {
        const btn = document.getElementById('btn-copy-filtered');
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = 'Copy filtered URL'; }, 2000);
    });
}

function esc(text) {
    if (text == null) return '';
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

function teamIcon(team) {
    if (team.logo_url) {
        // Proxy Liquipedia images to bypass hotlink protection
        const proxyUrl = `/image-proxy?url=${encodeURIComponent(team.logo_url)}`;
        return `<img src="${esc(proxyUrl)}" alt="${esc(team.short_name)}" class="team-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline'"><span class="emoji" style="display:none">${esc(team.emoji)}</span>`;
    }
    return `<span class="emoji">${esc(team.emoji)}</span>`;
}

function findTeamByName(name) {
    // Try exact match first
    let team = allTeams.find(t => t.name === name);
    if (team) return team;

    // Try case-insensitive match
    const lowerName = name.toLowerCase();
    team = allTeams.find(t => t.name.toLowerCase() === lowerName);
    if (team) return team;

    // Try short name match
    team = allTeams.find(t => t.short_name === name);
    if (team) return team;

    return null;
}

function opponentIcon(opponentName) {
    const team = findTeamByName(opponentName);
    if (team && team.logo_url) {
        const proxyUrl = `/image-proxy?url=${encodeURIComponent(team.logo_url)}`;
        return `<img src="${esc(proxyUrl)}" alt="${esc(opponentName)}" class="team-logo" onerror="this.style.display='none'">`;
    }
    // No logo found, return nothing (just show opponent name)
    return '';
}

// =====================================================================
// Panel toggle (tablet/mobile)
// =====================================================================
function togglePanel() {
    const panel = document.getElementById('panel');
    const overlay = document.getElementById('panel-overlay');
    panel.classList.toggle('open');
    overlay.classList.toggle('visible');
}

function closePanel() {
    document.getElementById('panel').classList.remove('open');
    document.getElementById('panel-overlay').classList.remove('visible');
}

// =====================================================================
// Mobile tabs
// =====================================================================
function setMobileTab(tab) {
    mobileActiveTab = tab;
    document.body.classList.remove('mobile-view-teams', 'mobile-view-subscribe');

    // Update tab active state
    document.querySelectorAll('.mobile-tab').forEach(function(el) {
        el.classList.toggle('active', el.dataset.tab === tab);
    });

    if (tab === 'teams') {
        document.body.classList.add('mobile-view-teams');
        document.getElementById('panel').classList.add('open');
    } else {
        document.getElementById('panel').classList.remove('open');
    }

    if (tab === 'subscribe') {
        const bar = document.getElementById('subscribe-bar');
        bar.classList.add('expanded');
    }
}

// =====================================================================
// Event Delegation
// =====================================================================
document.addEventListener('click', function(e) {
    // Mobile menu toggle
    if (e.target.closest('#mobile-menu-btn')) {
        togglePanel();
        return;
    }

    // Panel overlay close
    if (e.target.closest('#panel-overlay')) {
        closePanel();
        return;
    }

    // League chip click
    const leagueChip = e.target.closest('.league-chip');
    if (leagueChip && leagueChip.dataset.league) {
        toggleLeague(leagueChip.dataset.league);
        return;
    }

    // League group header toggle
    const leagueToggle = e.target.closest('[data-league-toggle]');
    if (leagueToggle && !e.target.closest('[data-add-all]')) {
        const body = leagueToggle.nextElementSibling;
        const isCollapsed = body.classList.contains('collapsed');
        body.classList.toggle('collapsed');
        leagueToggle.classList.toggle('collapsed');
        return;
    }

    // Add all button
    const addAll = e.target.closest('[data-add-all]');
    if (addAll) {
        addAllLeague(addAll.dataset.addAll);
        return;
    }

    // Team card click (browse panel)
    const teamCard = e.target.closest('.team-card');
    if (teamCard && teamCard.dataset.slug) {
        toggleTeam(teamCard.dataset.slug);
        return;
    }

    // Remove from selected (pill × button)
    const removeBtn = e.target.closest('[data-remove]');
    if (removeBtn) {
        toggleTeam(removeBtn.dataset.remove);
        return;
    }

    // Clear all
    if (e.target.closest('#clear-all-btn')) {
        clearAll();
        return;
    }

    // Region filter
    const regionTag = e.target.closest('.region-tag');
    if (regionTag && regionTag.dataset.region !== undefined) {
        setRegionFilter(regionTag.dataset.region || null);
        return;
    }

    // Tournament filter
    const tournamentTag = e.target.closest('.tournament-tag');
    if (tournamentTag && tournamentTag.dataset.filterType !== undefined) {
        setTournamentFilter(tournamentTag.dataset.filterType, tournamentTag.dataset.tournament || null);
        return;
    }

    // Match card click → open URL
    const matchCard = e.target.closest('.match-card');
    if (matchCard && matchCard.dataset.url) {
        window.open(matchCard.dataset.url, '_blank', 'noopener');
        return;
    }

    // Subscribe bar toggle
    if (e.target.closest('#subscribe-toggle')) {
        document.getElementById('subscribe-bar').classList.toggle('expanded');
        return;
    }

    // Copy URL buttons
    if (e.target.closest('#btn-copy')) {
        copyUrl();
        return;
    }
    if (e.target.closest('#btn-copy-filtered')) {
        copyFilteredUrl();
        return;
    }

    // Mobile tabs
    const mobileTab = e.target.closest('.mobile-tab');
    if (mobileTab && mobileTab.dataset.tab) {
        setMobileTab(mobileTab.dataset.tab);
        return;
    }
});

// Search input
document.addEventListener('input', function(e) {
    if (e.target.id === 'team-search') {
        teamSearchQuery = e.target.value;
        renderTeamBrowse();
    }
});

// =====================================================================
// Start
// =====================================================================
init();
</script>
</body>
</html>
